<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>PandaCare - Chat Room</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		<style>
			body {
				background-color: #f8f9fa;
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				height: 100vh;
				display: flex;
				flex-direction: column;
			}
			.navbar-brand {
				font-weight: bold;
				color: #7e57c2 !important;
			}
			.chat-container {
				flex-grow: 1;
				display: flex;
				flex-direction: column;
				height: calc(100vh - 80px);
			}
			.chat-header {
				background-color: #7e57c2;
				color: white;
				padding: 15px;
				border-top-left-radius: 10px;
				border-top-right-radius: 10px;
			}
			.messages-container {
				flex-grow: 1;
				overflow-y: auto;
				padding: 20px;
				background-color: #fff;
				border-left: 1px solid #dee2e6;
				border-right: 1px solid #dee2e6;
			}
			.message {
				margin-bottom: 15px;
				max-width: 70%;
			}
			.message-content {
				padding: 10px 15px;
				border-radius: 18px;
				display: inline-block;
			}
			.sent {
				margin-left: auto;
				text-align: right;
			}
			.sent .message-content {
				background-color: #7e57c2;
				color: white;
				border-bottom-right-radius: 5px;
			}
			.received {
				margin-right: auto;
				text-align: left;
			}
			.received .message-content {
				background-color: #f1f0f0;
				color: #333;
				border-bottom-left-radius: 5px;
			}
			.message-time {
				font-size: 0.75rem;
				color: #6c757d;
				margin-top: 5px;
			}
			.chat-input-container {
				padding: 15px;
				background-color: #fff;
				border: 1px solid #dee2e6;
				border-bottom-left-radius: 10px;
				border-bottom-right-radius: 10px;
			}
			.chat-input {
				border-radius: 20px;
				resize: none;
			}
			.btn-send {
				background-color: #7e57c2;
				border-color: #7e57c2;
				border-radius: 20px;
			}
			.btn-send:hover {
				background-color: #6a48b7;
				border-color: #6a48b7;
			}
			.back-button {
				text-decoration: none;
				color: #fff;
				display: inline-flex;
				align-items: center;
			}
			.back-button:hover {
				color: #e9ecef;
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
			<div class="container">
				<a
					class="navbar-brand"
					href="#"
					>PandaCare</a
				>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarNav"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div
					class="collapse navbar-collapse"
					id="navbarNav"
				>
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a
								class="nav-link"
								href="#"
								>Dashboard</a
							>
						</li>
						<li class="nav-item">
							<a
								class="nav-link active"
								href="#"
								>Messages</a
							>
						</li>
						<li class="nav-item">
							<a
								class="nav-link"
								href="#"
								>Profile</a
							>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container py-4 chat-container">
			<div class="chat-header">
				<div class="row align-items-center">
					<div class="col-auto">
						<a
							th:href="@{/chat/list(userId=${pacilianId},userType='PACILIAN')}"
							class="back-button"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="16"
								height="16"
								fill="currentColor"
								class="bi bi-arrow-left"
								viewBox="0 0 16 16"
							>
								<path
									fill-rule="evenodd"
									d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"
								/>
							</svg>
							<span class="ms-2">Back</span>
						</a>
					</div>
					<div class="col">
						<h5
							class="mb-0"
							th:text="${'Room ID: ' + room.roomId}"
						></h5>
						<small th:text="${'Chat with ' + caregiverId}"></small>
					</div>
				</div>
			</div>

			<div
				class="messages-container"
				id="messagesContainer"
			>
				<div
					th:each="message : ${messages}"
					th:class="${message.sender == pacilianId ? 'message sent' : 'message received'}"
				>
					<div
						class="message-content"
						th:text="${message.content}"
					></div>
					<div
						class="message-time"
						th:text="${#temporals.format(message.timestamp, 'dd MMM, HH:mm')}"
					></div>
				</div>
			</div>

			<div class="chat-input-container">
				<form
					th:action="@{/chat/send}"
					method="post"
					id="messageForm"
				>
					<input
						type="hidden"
						name="roomId"
						th:value="${room.roomId}"
					/>
					<input
						type="hidden"
						name="senderId"
						th:value="${pacilianId}"
					/>
					<input
						type="hidden"
						name="recipientId"
						th:value="${caregiverId}"
					/>

					<div class="input-group">
						<textarea
							class="form-control chat-input"
							name="content"
							id="content"
							placeholder="Type your message..."
							required
						></textarea>
						<button
							class="btn btn-primary btn-send"
							type="submit"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="16"
								height="16"
								fill="currentColor"
								class="bi bi-send"
								viewBox="0 0 16 16"
							>
								<path
									d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"
								/>
							</svg>
						</button>
					</div>
				</form>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
		<script th:inline="javascript">
			// Scroll to the bottom of the messages container
			function scrollToBottom() {
			    const container = document.getElementById('messagesContainer');
			    container.scrollTop = container.scrollHeight;
			}

			// Connect to WebSocket when the page loads
			document.addEventListener('DOMContentLoaded', function() {
			    scrollToBottom();

			    // WebSocket connection
			    var socket = new SockJS('/ws');
			    var stompClient = Stomp.over(socket);
			    var roomId = [[${room.roomId}]];
			    var pacilianId = [[${pacilianId}]];

			    stompClient.connect({}, function(frame) {
			        console.log('Connected: ' + frame);

			        // Subscribe to the room's message topic
			        stompClient.subscribe('/topic/messages/' + roomId, function(messageOutput) {
			            var message = JSON.parse(messageOutput.body);
			            showMessage(message);
			        });
			    });

			    // Handle form submission
			    document.getElementById('messageForm').addEventListener('submit', function(e) {
			        e.preventDefault();

			        var contentField = document.getElementById('content');
			        var content = contentField.value;

			        if (content) {
			            // Send the message via WebSocket
			            stompClient.send("/app/chat/" + roomId, {},
			                JSON.stringify({
			                    'sender': pacilianId,
			                    'recipient': [[${caregiverId}]],
			                    'content': content
			                })
			            );

			            contentField.value = '';
			        }
			    });

			    // Function to display a message
			    function showMessage(message) {
			        var messageContainer = document.createElement('div');
			        messageContainer.className = message.sender === pacilianId ? 'message sent' : 'message received';

			        var messageContent = document.createElement('div');
			        messageContent.className = 'message-content';
			        messageContent.textContent = message.content;

			        var messageTime = document.createElement('div');
			        messageTime.className = 'message-time';

			        // Format the timestamp
			        var timestamp = new Date(message.timestamp);
			        var formattedTime = timestamp.toLocaleDateString() + ', ' +
			                            timestamp.getHours().toString().padStart(2, '0') + ':' +
			                            timestamp.getMinutes().toString().padStart(2, '0');

			        messageTime.textContent = formattedTime;

			        messageContainer.appendChild(messageContent);
			        messageContainer.appendChild(messageTime);

			        document.getElementById('messagesContainer').appendChild(messageContainer);
			        scrollToBottom();
			    }
			});
		</script>
	</body>
</html>
